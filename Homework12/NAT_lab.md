
# Лабораторная работа - Настройка NAT для IPv4.
## Топология

![topology]()

## Таблица адресации 

| Устройство  | Интерфейс  | IPv6-адрес | Маска подсети |
| :------ |:------------:| --------:| ---------------:|
| R1      | G0/0/0  | 209.165.200.230 | 255.255.255.248 |
| R1      | G0/0/1  | 192.168.1.1     | 255.255.255.0   |
| R2      | G0/0/0  | 209.165.200.225 | 255.255.255.248 |
| R2      | Lo1     | 209.165.200.1   | 255.255.255.224 |
| S1      | VLAN 1  | 192.168.1.11    | 255.255.255.0   |
| S2      | VLAN 1  | 192.168.1.12    | 255.255.255.0   |
| PC-A    | NIC     | 192.168.1.2     | 255.255.255.0   |
| PC-B    | NIC     | 192.168.1.3     | 255.255.255.0   |

## Задачи:

### Часть 1. Создание сети и настройка основных параметров устройства.

### Часть 2. Настройка и проверка NAT для IPv4.

### Часть 3. Настройка и проверка PAT для IPv4.

### Часть 4. Настройка и проверка статического NAT для IPv4.

## Решение:

### Часть 1. Создание сети и настройка основных параметров устройства.

### Часть 2. Настройка и проверка NAT для IPv4.

#### Шаг 1. Настройте NAT на R1, используя пул из трех адресов 209.165.200.226-209.165.200.228: 

1.	Настройте простой список доступа, который определяет, какие хосты будут разрешены для трансляции. В этом случае все устройства в локальной сети R1 имеют право на трансляцию.

**R1(config)# access-list 1 permit 192.168.1.0 0.0.0.255**

2.	Создайте пул NAT и укажите ему имя и диапазон используемых адресов:
   
**R1(config)# ip nat pool PUBLIC_ACCESS 209.165.200.226 209.165.200.228 netmask 255.255.255.248**
 
*Примечание. Параметр маски сети не является разделителем IP-адресов. Это должна быть правильная маска подсети для назначенных адресов, даже если вы используете не все адреса подсети в пуле.*

3.	Настройте перевод, связывая ACL и пул с процессом преобразования:

**R1(config)# ip nat inside source list 1 pool PUBLIC_ACCESS**

*Примечание: Три очень важных момента. Во-первых, слово «inside» имеет решающее значение для работы такого рода NAT. Если вы опустить его, NAT не будет работать. Во-вторых, номер списка — это номер ACL, настроенный на предыдущем шаге. В-третьих, имя пула чувствительно к регистру.*

4.	Задайте внутренний (inside) интерфейс:
 
**R1(config)# interface g0/0/1**

**R1(config-if)# ip nat inside**

5.	Определите внешний (outside) интерфейс:

**R1(config)# interface g0/0/0**

**R1(config-if)# ip nat outside**


    R1(config)#
    R1(config)#access-list 1 permit 192.168.1.0 0.0.0.255
    R1(config)#ip nat pool PUBLIC_ACCESS 209.165.200.226 209.165.200.228 netmask 255.255.255.248
    R1(config)#ip nat inside source list 1 pool PUBLIC_ACCESS
    R1(config)#int g0/0/1
    R1(config-if)#ip nat inside
    R1(config-if)#int g0/0/0
    R1(config-if)#ip nat outside


#### Шаг 2. Проверьте конфигурацию: 

1. С PC-B, запустите эхо-запрос интерфейса Lo1 (209.165.200.1) на R2:

   ![PC-B_Ping_Lo1]()

2.	С PC-A, запустите  эхо-запрос интерфейса Lo1 (209.165.200.1) на R2. Если эхо-запрос не прошел, выполните отладку. На R1 отобразите таблицу NAT на R1 с помощью команды **show ip nat translations**.

   ![PC-A_Ping_Lo1]()

3.	Обратите внимание, что предыдущая трансляция для PC-B все еще находится в таблице. Из S1, эхо-запрос интерфейса Lo1 (209.165.200.1) на R2. Если эхо-запрос не прошел, выполните отладку. На R1 отобразите таблицу NAT на R1 с помощью команды **show ip nat translations**.

   ![S1_Ping_Lo1]()
   
   ![R1_NAT]()

4.	Теперь запускаем пинг R2 Lo1 из S2. На этот раз перевод завершается неудачей, и вы получаете эти сообщения (или аналогичные) на консоли R1:

   Sep 23 15:43:55.562: %IOSXE-6-PLATFORM: R0/0: cpp_cp: QFP:0.0 Thread:000 TS:00000001473688385900 %NAT-6-ADDR_ALLOC_FAILURE: Address allocation failed; pool 1 may be exhausted [2]

5.	Это ожидаемый результат, потому что выделено только 3 адреса, и мы попытались ping Lo1 с четырех устройств. Напомним, что NAT — это трансляция «один-в-один». Как много выделено трансляций? Введите команду **show ip nat translations verbose** , и вы увидите, что ответ будет 24 часа.

   ![R1_sh_ip_nat]()

6.	Учитывая, что пул ограничен тремя адресами, NAT для пула адресов недостаточно для нашего приложения. Очистите преобразование NAT и статистику, и мы перейдем к PAT.

    R1#clear ip nat translations * 
    R1#clear ip nat statistics 

### Часть 3. Настройка и проверка PAT для IPv4.

#### Шаг 1. Удалите команду преобразования на R1:

1. Компоненты конфигурации преобразования адресов в основном одинаковы; что-то (список доступа) для идентификации адресов, пригодных для перевода, дополнительно настроенный пул адресов для их преобразования и команды, необходимые для идентификации внутреннего и внешнего интерфейсов. Из части 1 наш список доступа (список доступа 1) по-прежнему корректен для сетевого сценария, поэтому нет необходимости воссоздавать его. Мы будем использовать один и тот же пул адресов, поэтому нет необходимости воссоздавать эту конфигурацию. Кроме того, внутренний и внешний интерфейсы не меняются. Чтобы начать работу в части 3, удалите команду, связывающую ACL и пул вместе.

    R1(config)# no ip nat inside source list 1 pool PUBLIC_ACCESS 

#### Шаг 2. Добавьте команду PAT на R1:

1.Теперь настройте преобразование PAT в пул адресов (помните, что ACL и Pool уже настроены, так что это единственная команда, которую нам нужно изменить с NAT на PAT).

    R1(config)# ip nat inside source list 1 pool PUBLIC_ACCESS overload 

#### Шаг 3. Протестируйте и проверьте конфигурацию.

1.	Давайте проверим, что PAT работает. С PC-B,  запустите эхо-запрос интерфейса Lo1 (209.165.200.1) на R2. Если эхо-запрос не прошел, выполните отладку. На R1 отобразите таблицу NAT на R1 с помощью команды **show ip nat translations**.

    R1# show ip nat translations
    Pro Inside global Inside local Outside local Outside global
    226:1 192.168.1. 3:1 209.165.200. 1:1 209.165.200. 1:1
    Total number of translations: 1#

2.	С PC-A, запустите эхо-запрос интерфейса Lo1 (209.165.200.1) на R2. Если эхо-запрос не прошел, выполните отладку. На R1 отобразите таблицу NAT на R1 с помощью команды **show ip nat translations**.

   ![R1_sh_ip_nat_tr]()

3. Обратите внимание, что есть только одна трансляция. Отправьте **ping** еще раз, и быстро вернитесь к маршрутизатору и введите команду **show ip nat translations verbose**, и вы увидите, что произошло:

   ![R1_sh_ip_nat_tr_vebr]()

4.	Генерирует трафик с нескольких устройств для наблюдения PAT. На PC-A и PC-B используйте параметр -t с командой ping, чтобы отправить безостановочный ping на интерфейс Lo1 R2 (ping -t 209.165.200.1), затем вернитесь к R1 и выполните команду **show ip nat translations**:










